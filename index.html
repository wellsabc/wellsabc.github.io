<!DOCTYPE html>
<html>
<head>
  <title>خريطة مواقع الينابيع حسب المناطق</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; width: 100vw; }
    #controls { padding: 10px; background: #f9f9f9; }
    .region-label { pointer-events: none; }
  </style>
</head>
<body>

<div id="controls">
  <label>اختر المنطقة:</label>
  <select id="zoneSelect">
    <option value="">-- اختر المنطقة --</option>
    <option value="A">المنطقة أ</option>
    <option value="B">المنطقة ب</option>
    <option value="C">المنطقة ج</option>
    <option value="all">كل المناطق</option>
  </select>
  <label style="margin-left: 20px;">فلترة حسب LandClassi:</label>
  <select id="landClassiSelect">
    <option value="all">كل الأنواع</option>
    <option value="Agricultural">زراعي</option>
    <option value="Domestic">منزلي</option>
    <option value="Industrial">صناعي</option>
    <option value="Mixed">مختلط</option>
  </select>
  <span id="count" style="margin-left:20px; font-weight:bold;"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
  const map = L.map('map').setView([32,35], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'© OpenStreetMap contributors'}).addTo(map);

  let abcData, allWellsData, wellsLayer, labelLayer;

  fetch('ABC.geojson').then(r=>r.json()).then(data=>{
    abcData = data;
    L.geoJSON(data, { style:{color:'green'} }).addTo(map);
    map.fitBounds(L.geoJSON(data).getBounds());
  });

  fetch('Wells.json').then(r=>r.json()).then(data=>{
    allWellsData = data;
  });

  const getColor = v => ({
    Agricultural:'green', Domestic:'blue',
    Industrial:'red', Mixed:'orange'
  }[v] || 'gray');

  function display() {
    if (!abcData || !allWellsData) return;
    const zone = document.getElementById('zoneSelect').value;
    const lc = document.getElementById('landClassiSelect').value;

    if (wellsLayer) map.removeLayer(wellsLayer);
    if (labelLayer) map.removeLayer(labelLayer);

    let features = allWellsData.features;
    if (zone && zone !== 'all') {
      const poly = abcData.features.find(f=>
        (f.properties.zone||'').toUpperCase() === zone.toUpperCase());
      if (poly) {
        features = turf.pointsWithinPolygon(
          {type:'FeatureCollection',features}, poly).features;
        const c = turf.centerOfMass(poly).geometry.coordinates;
        labelLayer = L.marker([c[1],c[0]], {
          icon: L.divIcon({
            className:'region-label',
            html:`<div style="font-size:18px;
              font-weight:bold;color:darkgreen;">المنطقة ${zone}</div>`
          })
        }).addTo(map);
        map.fitBounds(L.geoJSON(poly).getBounds());
      } else {
        console.warn('لم يتم العثور على المضلع للمنطقة ',zone);
      }
    }
    if (lc && lc !== 'all') {
      features = features.filter(f=>f.properties?.LandClassi === lc);
    }

    document.getElementById('count').textContent =
      `عدد الينابيع: ${features.length}`;

    wellsLayer = L.geoJSON({type:'FeatureCollection',features}, {
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:6, fillColor:getColor(f.properties?.LandClassi),
        color:'#000', weight:1, fillOpacity:0.8
      }),
      onEachFeature:(f,layer)=> {
        layer.bindPopup(
          `<b>${f.properties?.name||'بئر'}<br>LandClassi: ${
           f.properties?.LandClassi||'غير معروف'}</b>`);
      }
    }).addTo(map);
  }

  document.getElementById('zoneSelect').addEventListener('change',display);
  document.getElementById('landClassiSelect').addEventListener('change',display);
</script>
</body>
</html>
