<!DOCTYPE html>
<html>
<head>
    <title>تحديد الينابيع حسب المنطقة - Leaflet + Turf.js</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 85vh; width: 100vw; }
        #controls {
            padding: 10px;
            background: #f0f0f0;
            font-family: Arial;
        }
        #info {
            padding: 10px;
            font-family: Arial;
            background: #f9f9f9;
        }
    </style>
</head>
<body>

<div id="controls">
    <label for="zoneSelect">اختر المنطقة:</label>
    <select id="zoneSelect">
        <option value="all">كل المناطق</option>
        <option value="A">المنطقة أ</option>
        <option value="B">المنطقة ب</option>
        <option value="C">المنطقة ج</option>
    </select>
</div>

<div id="info"></div>
<div id="map"></div>

<!-- Leaflet & Turf.js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    const map = L.map('map').setView([32.0, 35.0], 10);

    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    let abcData = null;
    let wellsData = null;

    let abcLayer;
    let wellsLayer;
    let intersectedWellsLayer;

    // تحميل طبقة ABC.geojson
    fetch('ABC.geojson')
        .then(res => res.json())
        .then(data => {
            abcData = data;
            abcLayer = L.geoJSON(data, {
                style: { color: 'green', fillOpacity: 0.1 },
                onEachFeature: (feature, layer) => {
                    const z = feature.properties?.zone || '؟';
                    layer.bindPopup(`المنطقة: ${z}`);
                }
            }).addTo(map);
            map.fitBounds(abcLayer.getBounds());
        });

    // تحميل طبقة Wells.json
    fetch('Wells.json')
        .then(res => res.json())
        .then(data => {
            wellsData = data;
            wellsLayer = L.geoJSON(data, {
                pointToLayer: (feature, latlng) => {
                    return L.circleMarker(latlng, {
                        radius: 5,
                        color: 'blue',
                        fillColor: 'lightblue',
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                    const name = feature.properties?.name || 'بئر';
                    layer.bindPopup(`اسم البئر: ${name}`);
                }
            }).addTo(map);
        });

    // عند تغيير المنطقة
    document.getElementById("zoneSelect").addEventListener("change", () => {
        const selectedZone = document.getElementById("zoneSelect").value;

        // إزالة الطبقات السابقة
        if (intersectedWellsLayer) {
            map.removeLayer(intersectedWellsLayer);
        }

        if (selectedZone === "all") {
            wellsLayer.addTo(map);
            document.getElementById("info").innerHTML = "";
            return;
        }

        // إخفاء كل الينابيع مؤقتاً
        map.removeLayer(wellsLayer);

        // تحديد مضلعات المنطقة المطلوبة
        const selectedPolygons = abcData.features.filter(f => f.properties.zone === selectedZone);

        if (selectedPolygons.length === 0) {
            document.getElementById("info").innerHTML = "لا توجد مضلعات لهذه المنطقة.";
            return;
        }

        const selectedPolygonCollection = {
            type: "FeatureCollection",
            features: selectedPolygons
        };

        // إيجاد الينابيع التي تتقاطع مع المضلعات
        const intersected = wellsData.features.filter(well => {
            return selectedPolygons.some(poly =>
                turf.booleanPointInPolygon(well, poly)
            );
        });

        // عرض النتائج
        intersectedWellsLayer = L.geoJSON({
            type: "FeatureCollection",
            features: intersected
        }, {
            pointToLayer: (feature, latlng) => {
                return L.circleMarker(latlng, {
                    radius: 6,
                    color: "red",
                    fillColor: "pink",
                    fillOpacity: 0.8
                });
            },
            onEachFeature: (feature, layer) => {
                const name = feature.properties?.name || 'بئر';
                layer.bindPopup(`اسم البئر: ${name}`);
            }
        }).addTo(map);

        // إظهار عدد الينابيع وتفاصيلها
        const infoDiv = document.getElementById("info");
        let html = `<strong>عدد الينابيع في المنطقة ${selectedZone}: ${intersected.length}</strong><br>`;
        html += "<ul>";
        intersected.forEach(w => {
            const n = w.properties?.name || "بئر بدون اسم";
            html += `<li>${n}</li>`;
        });
        html += "</ul>";
        infoDiv.innerHTML = html;
    });
</script>

</body>
</html>
