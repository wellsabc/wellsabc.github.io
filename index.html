<!DOCTYPE html>
<html>
<head>
    <title>خريطة Leaflet - فلترة الينابيع حسب المنطقة ونوع الاستخدام</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100vw; }
        #controls {
            padding: 10px;
            background: #f9f9f9;
        }
        #regionName {
            margin-top: 5px;
            font-weight: bold;
            color: #444;
        }
    </style>
</head>
<body>

<div id="controls">
    <label for="zoneSelect">اختر المنطقة:</label>
    <select id="zoneSelect">
        <option value="">-- اختر المنطقة --</option>
        <option value="A">المنطقة أ</option>
        <option value="B">المنطقة ب</option>
        <option value="C">المنطقة ج</option>
        <option value="all">كل المناطق</option>
    </select>

    <label for="landClassiSelect" style="margin-right: 15px;">اختر نوع الاستخدام:</label>
    <select id="landClassiSelect">
        <option value="all">كل الأنواع</option>
        <option value="Agricultural">زراعي</option>
        <option value="Domestic">منزلي</option>
        <option value="Industrial">صناعي</option>
        <option value="Mixed">مختلط</option>
    </select>

    <div id="count"></div>
    <div id="regionName"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<script>
    const map = L.map('map').setView([32.0, 35.0], 10);

    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    let abcLayer, wellsLayer, labelLayer;
    let allWellsData = null;
    let abcData = null;

    // تحميل المناطق
    fetch('ABC.geojson')
        .then(response => response.json())
        .then(data => {
            abcData = data;
            abcLayer = L.geoJSON(data, {
                style: { color: 'green' },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup("منطقة: " + feature.properties.zone);
                }
            }).addTo(map);
            map.fitBounds(abcLayer.getBounds());
        });

    // تحميل الينابيع
    fetch('Wells.json')
        .then(response => response.json())
        .then(data => {
            allWellsData = data;
        });

    function getColorByLandClassi(value) {
        switch (value) {
            case "Agricultural": return "green";
            case "Domestic": return "blue";
            case "Industrial": return "red";
            case "Mixed": return "orange";
            default: return "gray";
        }
    }

    function displayWells() {
        if (!allWellsData || !abcData) return;

        const selectedZone = document.getElementById("zoneSelect").value;
        const selectedLandClassi = document.getElementById("landClassiSelect").value;

        if (wellsLayer) map.removeLayer(wellsLayer);
        if (labelLayer) map.removeLayer(labelLayer);

        let filtered = [];

        // فلترة حسب المنطقة
        if (selectedZone === "all") {
            filtered = allWellsData.features;
        } else {
            const polygon = abcData.features.find(f => f.properties.zone === selectedZone);
            if (!polygon) return;
            const ptsWithin = turf.pointsWithinPolygon(allWellsData, polygon);
            filtered = ptsWithin.features;

            // اسم المنطقة
            const center = turf.centerOfMass(polygon).geometry.coordinates;
            labelLayer = L.marker([center[1], center[0]], {
                icon: L.divIcon({
                    className: 'region-label',
                    html: `<div style="font-size:16px; font-weight:bold; color:darkgreen;">المنطقة ${selectedZone}</div>`
                })
            }).addTo(map);

            document.getElementById("regionName").innerText = `المنطقة المختارة: ${selectedZone}`;
        }

        // فلترة حسب نوع LandClassi
        if (selectedLandClassi !== "all") {
            filtered = filtered.filter(f => f.properties?.LandClassi === selectedLandClassi);
        }

        document.getElementById("count").innerHTML = `عدد الينابيع: ${filtered.length}`;

        // عرض النقاط
        wellsLayer = L.geoJSON({ type: "FeatureCollection", features: filtered }, {
            onEachFeature: function(feature, layer) {
                const name = feature.properties?.name || "بئر غير مسمى";
                const land = feature.properties?.LandClassi || "غير معروف";
                layer.bindPopup(`<b>اسم البئر:</b> ${name}<br><b>LandClassi:</b> ${land}`);
            },
            pointToLayer: function(feature, latlng) {
                const color = getColorByLandClassi(feature.properties?.LandClassi);
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
        }).addTo(map);
    }

    // الاستماع لتغيّر كلا القائمتين
    document.getElementById("zoneSelect").addEventListener("change", displayWells);
    document.getElementById("landClassiSelect").addEventListener("change", displayWells);
</script>

</body>
</html>
