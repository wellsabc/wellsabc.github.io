<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>خريطة الينابيع - بيانات حقيقية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body { font-family: Arial; direction: rtl; margin: 0; }
    #map { height: 600px; width: 100%; }
    #controls { padding: 10px; }
    #info { padding: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="areaSelect">اختر المنطقة:</label>
    <select id="areaSelect">
      <option value="">-- اختر --</option>
      <option value="A">منطقة أ</option>
      <option value="B">منطقة ب</option>
      <option value="C">منطقة ج</option>
    </select>
  </div>
  <div id="info">عدد الينابيع: 0</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    const map = L.map('map').setView([31.9, 35.2], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    let wellsGeoJSON = null;

    const areasGeoJSON = {
      A: {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[
            [35.1, 31.95],
            [35.3, 31.95],
            [35.3, 31.85],
            [35.1, 31.85],
            [35.1, 31.95]
          ]]
        }
      },
      B: {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[
            [35.3, 31.85],
            [35.5, 31.85],
            [35.5, 31.75],
            [35.3, 31.75],
            [35.3, 31.85]
          ]]
        }
      },
      C: {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[
            [35.3, 31.95],
            [35.5, 31.95],
            [35.5, 31.85],
            [35.3, 31.85],
            [35.3, 31.95]
          ]]
        }
      }
    };

    const areasLayers = {};
    for (const key in areasGeoJSON) {
      areasLayers[key] = L.geoJSON(areasGeoJSON[key], { color: 'blue' });
    }

    function showAllWells() {
      markersLayer.clearLayers();
      let features = wellsGeoJSON.features;

      features.forEach(f => {
        const coords = f.geometry.coordinates.reverse(); // lat, lng
        const name = f.properties.name || "ينبوع";
        L.marker(coords).bindPopup(`<b>${name}</b>`).addTo(markersLayer);
      });

      document.getElementById('info').textContent = "عدد الينابيع: " + features.length;

      const bounds = L.geoJSON(wellsGeoJSON).getBounds();
      map.fitBounds(bounds.pad(0.2));
    }

    function filterWellsByArea(areaKey) {
      markersLayer.clearLayers();

      Object.values(areasLayers).forEach(layer => {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      });

      if (!areaKey || !areasGeoJSON[areaKey]) {
        showAllWells();
        return;
      }

      areasLayers[areaKey].addTo(map);
      const polygon = areasGeoJSON[areaKey];
      const filtered = wellsGeoJSON.features.filter(f => {
        const pt = turf.point(f.geometry.coordinates);
        return turf.booleanPointInPolygon(pt, polygon);
      });

      document.getElementById('info').textContent = "عدد الينابيع: " + filtered.length;

      filtered.forEach(f => {
        const coords = [...f.geometry.coordinates].reverse(); // lat, lng
        const name = f.properties.name || "ينبوع";
        L.marker(coords).bindPopup(`<b>${name}</b>`).addTo(markersLayer);
      });

      if (filtered.length > 0) {
        const bounds = L.geoJSON({ type: "FeatureCollection", features: filtered }).getBounds();
        map.fitBounds(bounds.pad(0.2));
      }
    }

    document.getElementById('areaSelect').addEventListener('change', e => {
      filterWellsByArea(e.target.value);
    });

    // تحميل ملف GeoJSON الحقيقي (يجب أن يكون في نفس المجلد أو مسار صحيح)
    fetch('Wells.json')
      .then(res => res.json())
      .then(data => {
        wellsGeoJSON = data;
        showAllWells(); // عرض كل النقاط عند البداية
      })
      .catch(err => console.error("فشل تحميل ملف Wells.json:", err));
  </script>
</body>
</html>
