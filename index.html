<!DOCTYPE html>
<html>
<head>
    <title>تحديد الينابيع حسب المنطقة (Select by Location)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100vw; }
        #controls {
            padding: 10px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>

<div id="controls">
    <label for="zoneSelect">اختر المنطقة:</label>
    <select id="zoneSelect">
        <option value="all">كل المناطق</option>
        <option value="A">المنطقة أ</option>
        <option value="B">المنطقة ب</option>
        <option value="C">المنطقة ج</option>
    </select>
    <span id="count"></span>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Turf.js لتحليل التقاطعات -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    const map = L.map('map').setView([32.0, 35.0], 10);

    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    let abcLayer, wellsLayer;
    let allABC, allWells;

    // تحميل المناطق
    fetch('ABC.geojson')
        .then(res => res.json())
        .then(data => {
            allABC = data;
            abcLayer = L.geoJSON(data, {
                style: { color: "green", weight: 2 },
                onEachFeature: (feature, layer) => {
                    layer.bindPopup("المنطقة: " + feature.properties.zone);
                }
            }).addTo(map);
            map.fitBounds(abcLayer.getBounds());
        });

    // تحميل الينابيع
    fetch('Wells.json')
        .then(res => res.json())
        .then(data => {
            allWells = data;
            selectWells("all"); // بدايةً عرض الكل
        });

    // دالة التحديد حسب المنطقة
    function selectWells(selectedZone) {
        if (wellsLayer) map.removeLayer(wellsLayer);

        let selectedPolygons;
        if (selectedZone === "all") {
            selectedPolygons = allABC.features;
        } else {
            selectedPolygons = allABC.features.filter(f => f.properties.zone === selectedZone);
        }

        const selectedWells = allWells.features.filter(well => {
            return selectedPolygons.some(polygon => {
                return turf.booleanPointInPolygon(well, polygon);
            });
        });

        // عدد النقاط المحددة
        document.getElementById("count").innerText = `عدد الينابيع: ${selectedWells.length}`;

        // عرض النقاط
        wellsLayer = L.geoJSON({
            type: "FeatureCollection",
            features: selectedWells
        }, {
            pointToLayer: (feature, latlng) => {
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "blue",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: (feature, layer) => {
                layer.bindPopup("اسم البئر: " + (feature.properties?.name || "بدون اسم"));
            }
        }).addTo(map);
    }

    // عند تغيير المنطقة
    document.getElementById("zoneSelect").addEventListener("change", function () {
        selectWells(this.value);
    });
</script>

</body>
</html>
